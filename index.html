<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ‡®ðŸ‡© Indonesia Real-Time Population</title>
    
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    
    <style>
        body { padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .loader { 
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .province-flag { width: 32px; height: 32px; object-fit: cover; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-6 fw-bold">ðŸ‡®ðŸ‡© Indonesia Population Dashboard</h1>
            <button class="btn btn-outline-info" onclick="refreshData()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>

        <div id="loading" class="loader"></div>
        <div id="error-message" class="alert alert-danger d-none"></div>
        
        <div id="content" class="d-none">
            <!-- Total Population -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5 class="text-muted">Total Population (2023)</h5>
                    <h2 class="text-primary" id="totalPopulation">-</h2>
                    <p class="text-muted">Last updated: <span id="lastUpdated">-</span></p>
                </div>
            </div>

            <!-- Provincial Chart -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <i class="fas fa-chart-bar me-2"></i>Provincial Population Distribution
                </div>
                <div class="card-body">
                    <canvas id="provinceChart"></canvas>
                </div>
            </div>

            <!-- Regional Data Explorer -->
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between">
                    <span><i class="fas fa-table me-2"></i>Regional Data</span>
                    <select id="provinceFilter" class="form-select w-auto">
                        <option value="">Select Province</option>
                    </select>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="regencyTable">
                            <thead>
                                <tr>
                                    <th>Region</th>
                                    <th>Population</th>
                                    <th>Area (kmÂ²)</th>
                                    <th>Density</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BPS_API_KEY = '6b47ec33eb086414844602c0c042707a';
        let provinceData = [];
        let regencyData = [];

        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        async function init() {
            try {
                showLoading();
                
                // Ambil data nasional
                const national = await fetchBPSData('data/domain/0/var/721');
                const provinces = await fetchBPSData('domain/354');
                const regencies = await fetchBPSData('domain/355');

                if (!national || !provinces || !regencies) {
                    throw new Error('Incomplete data from BPS API');
                }

                // Proses data
                const totalPopulation = national.data.find(d => d.nama === "INDONESIA")?.jumlah || 0;
                provinceData = provinces.data.map(p => ({
                    name: p.nama,
                    population: p.jumlah,
                    code: p.kode
                }));

                regencyData = regencies.data.map(r => ({
                    provinceCode: r.kode_parent,
                    name: r.nama,
                    population: r.jumlah,
                    area: r.luas || 0
                }));

                // Update UI
                document.getElementById('totalPopulation').textContent = formatNumber(totalPopulation);
                document.getElementById('lastUpdated').textContent = luxon.DateTime.now().toLocaleString('id-ID');

                createProvinceChart(provinceData);
                populateProvinceFilter();
                
                showContent();
            } catch (error) {
                showError(`Initialization failed: ${error.message}`);
                console.error('Error:', error);
            }
        }

        async function fetchBPSData(endpoint) {
            try {
                const response = await fetch(`https://webapi.bps.go.id/v1/api/${endpoint}/key/${BPS_API_KEY}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                const data = await response.json();
                return data.data ? data.data : [];
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        function createProvinceChart(data) {
            const ctx = document.getElementById('provinceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'Population',
                        data: data.map(d => d.population),
                        backgroundColor: '#2c3e50',
                        borderColor: '#34495e',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.label}: ${formatNumber(ctx.raw)} jiwa`
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: (v) => formatNumber(v)
                            }
                        }
                    }
                }
            });
        }

        function populateProvinceFilter() {
            const filter = document.getElementById('provinceFilter');
            
            provinceData.forEach(p => {
                const option = document.createElement('option');
                option.value = p.code;
                option.textContent = p.name;
                filter.appendChild(option);
            });

            filter.addEventListener('change', (e) => {
                const code = e.target.value;
                const filtered = regencyData.filter(r => r.provinceCode === code);
                populateRegencyTable(filtered);
            });
        }

        function populateRegencyTable(data) {
            const tbody = document.getElementById('regencyTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = data.map(r => `
                <tr>
                    <td>${r.name}</td>
                    <td>${formatNumber(r.population)}</td>
                    <td>${formatNumber(r.area)}</td>
                    <td>${calculateDensity(r.population, r.area)} /kmÂ²</td>
                </tr>
            `).join('');
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function calculateDensity(population, area) {
            return area > 0 ? (population / area).toFixed(1) : '0';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').classList.add('d-none');
            document.getElementById('error-message').classList.add('d-none');
        }

        function showContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').classList.remove('d-none');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').classList.remove('d-none');
            document.getElementById('loading').style.display = 'none';
        }

        function refreshData() {
            showLoading();
            setTimeout(init, 1000);
        }
    </script>
</body>
</html>
