<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ‡®ðŸ‡© BPS Domain Explorer</title>
    
    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    
    <style>
        body { padding: 20px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .domain-card { cursor: pointer; transition: transform 0.2s; }
        .domain-card:hover { transform: translateY(-5px); }
        .province-flag { width: 32px; height: 32px; object-fit: cover; margin-right: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-6 fw-bold">BPS Domain Explorer</h1>
            <div class="d-flex">
                <select id="domainType" class="form-select me-2 w-auto">
                    <option value="prov">Province</option>
                    <option value="kab">City/Regency</option>
                    <option value="kabbyprov">City by Province</option>
                </select>
                <button class="btn btn-outline-info" onclick="refreshData()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>

        <div id="loading" class="loader"></div>
        <div id="error-message" class="alert alert-danger d-none"></div>
        
        <div id="content" class="d-none">
            <!-- Province Selection for kabbyprov -->
            <div class="row mb-3 d-none" id="provinceSelector">
                <div class="col-md-4">
                    <select id="provinceFilter" class="form-select">
                        <option value="">Select Province</option>
                    </select>
                </div>
            </div>

            <!-- Data Display -->
            <div class="row" id="dataContainer">
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-striped" id="domainTable">
                            <thead>
                                <tr>
                                    <th>Domain ID</th>
                                    <th>Name</th>
                                    <th>URL</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BPS_API_KEY = '6b47ec33eb086414844602c0c042707a';
        let currentDomains = [];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('domainType').addEventListener('change', handleTypeChange);
            init();
        });

        async function init() {
            try {
                showLoading();
                await fetchDomains('prov');
                showContent();
            } catch (error) {
                showError(error.message);
            }
        }

        async function fetchDomains(type, provId = null) {
            try {
                let endpoint = `domain/${type}`;
                if (type === 'kabbyprov' && provId) endpoint += `/${provId}`;
                
                const response = await fetch(
                    `https://webapi.bps.go.id/v1/api/${endpoint}/key/${BPS_API_KEY}`
                );
                
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                
                return data.data[0]?.data || [];
            } catch (error) {
                console.error('Error fetching domains:', error);
                return [];
            }
        }

        function populateTable(data) {
            const tbody = document.getElementById('domainTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.domain_id}</td>
                    <td>${item.domain_name}</td>
                    <td><a href="${item.domain_url}" target="_blank">${item.domain_url}</a></td>
                    <td>${getTypeLabel(item.domain_id)}</td>
                </tr>
            `).join('');
        }

        function getTypeLabel(domainId) {
            if (domainId.length === 2) return 'Province';
            if (domainId.length === 4) return 'City/Regency';
            return 'National';
        }

        async function handleTypeChange(e) {
            const type = e.target.value;
            showLoading();
            
            try {
                if (type === 'kabbyprov') {
                    // Tampilkan dropdown provinsi
                    document.getElementById('provinceSelector').classList.remove('d-none');
                    const provinces = await fetchDomains('prov');
                    
                    const provSelect = document.getElementById('provinceFilter');
                    provSelect.innerHTML = '<option value="">Select Province</option>';
                    provinces.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.domain_id;
                        option.textContent = p.domain_name;
                        provSelect.appendChild(option);
                    });
                    
                    provSelect.addEventListener('change', async (e) => {
                        if (e.target.value) {
                            showLoading();
                            const cities = await fetchDomains('kabbyprov', e.target.value);
                            populateTable(cities);
                            showContent();
                        }
                    });
                } else {
                    document.getElementById('provinceSelector').classList.add('d-none');
                    const domains = await fetchDomains(type);
                    populateTable(domains);
                    showContent();
                }
            } catch (error) {
                showError('Failed to load domain data');
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').classList.add('d-none');
            document.getElementById('error-message').classList.add('d-none');
        }

        function showContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').classList.remove('d-none');
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').classList.remove('d-none');
            document.getElementById('loading').style.display = 'none';
        }

        function refreshData() {
            showLoading();
            setTimeout(() => {
                const type = document.getElementById('domainType').value;
                if (type === 'kabbyprov') {
                    const provId = document.getElementById('provinceFilter').value;
                    handleTypeChange({ target: { value: type } });
                } else {
                    handleTypeChange({ target: { value: type } });
                }
            }, 1000);
        }
    </script>
</body>
</html>
